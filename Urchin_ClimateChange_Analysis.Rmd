---
title: "Analysis for Growth and calcification response of the common collector urchin, _Tripneustes gratilla_, to projected climate change: effects of warming and acidification."
author: "Emily Sesno"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
    smart: false
  pdf_document:
    keep_tex: yes
---

```{r setup, message=FALSE, warning=FALSE}

rm(list=ls(all=TRUE)) 
results <- read.csv("Data/Urchin_ClimateChange_Data.csv", header=T, na="NA")

library("lsmeans") #post-hoc tests
library("effects") #plot effects of modeling
library("lmtest") #linear mixed modeling
library("lme4") #linear mixed modeling
library("lmerTest") #calculate p-values in models
library("emmeans") #post-hoc tests
library("cowplot") #arrange plots
library("MuMIn")
library("car") #levenes tests, Anova, qqPlots, 
library("tidyverse")
library("stats")
library("plyr")  #splitting, applying, and combining data
library("dplyr")
library("onewaytests") #allows for Welch test with unequal variances (spine lengths)
library("stats")
library("effsize")
library("FSA")
library("rcompanion")
library("broom") #turns model output into data frames
library("plotrix") #Calculates standard error of the mean
```

## Analysis approach:  
1. Build and run model  
2. Check for normality of residuals  
3. Check for homogeniety of variance of residuals  
4. Look at model summary  
5. Run anova to check for significance of main effects  
6. Run post-hoc to test hypotheses  

```{r Mean Results=TRUE}

###attempt to calculate means and ANOVAs for other means from paper. Will try to make a table too :) https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/

##Means of Day-24 sizes
InitialDiameter <-
  #seperate out the initial sizes of urchins on day 1, when desired conditions were met.
  results %>% 
    select("Day", "Diam1", "Diam2", "TankID") %>%
    filter(TankID != "8t" ) %>% 
      #remove urchin number 8 which died halfway through
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
      #gather Diam1 and Diam2 into single column in order to make number of levels of each grouping factor < number of observations (as per error message previously recieved)
    filter(Day == "-24") %>% 
      #sizes on day -24  
    select("Diameter")

InitialMean <- mean(InitialDiameter$Diameter)
InitialSE <- std.error(InitialDiameter$Diameter)

## Means of Day1 Sizes
Day1Diameter <-
  #seperate out the initial sizes of urchins on day 1, when desired conditions were met.
  results %>% 
    select("Day", "Diam1", "Diam2", "TankID") %>%
    filter(TankID != "8t" ) %>% 
      #remove urchin number 8 which died halfway through
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
      #gather Diam1 and Diam2 into single column in order to make number of levels of each grouping factor < number of observations (as per error message previously recieved)
    filter(Day == "1") %>% 
      #sizes on day 1  
    select("Diameter")

Day1Mean <- mean(Day1Diameter$Diameter)
Day1SE <- std.error(Day1Diameter$Diameter)

```


## Growth  

Results: 

Test diameters were not significantly different among all urchins upon initial collection (mean = 7.54 +/- 0.29 mm; n=24; F3,20=0.851; p=0.4825) or after subsequent ramp-up of conditions (mean = 16.12 +/- 0.67 mm; n=24; F3,20=1.0907; p=0.3759). Increased temperatures significantly influenced growth (p = 0.042) while pH did not (p=0.611). Urchins grown in increased temperatures were 12 % larger than those in ambient conditions, regardless of pH. There was no interaction between temperature and pH (p=0.482).   

Analysis: 

### Initial as day 1

Subset data frame to obtain growth measurements.  
```{r Growth=TRUE}

### GROWTH MODEL 1: using day 1 as the first official day of experiment when desired environmental conditions were met (24 days after getting urchins. In that 24 days, they were acclimated and then conditions ramped up)


Initial <-
  #seperate out the initial sizes of urchins on day 1, when desired conditions were met.
  results %>% 
    select("Day", "Treatment", "Temperature", "pH", "Diam1", "Diam2", "TankID") %>%
    filter(TankID != "8t" ) %>% 
      #remove urchin number 8 which died halfway through
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
      #gather Diam1 and Diam2 into single column in order to make number of levels of each grouping factor < number of observations (as per error message previously recieved)
    filter(Day == "1") %>% 
      #sizes on day 1  
    select("Temperature", "pH", "Diameter", "TankID")
  mean(Initial$Diameter)
  std.error(Initial$Diameter)


Final <- 
  #seperate out the final sizes of urchins on day 126
   results %>% 
    select("Day", "Treatment", "Temperature", "pH", "Diam1", "Diam2", "TankID") %>% 
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
      #gather Diam1 and Diam2 into single column
    filter(Day == "126") %>% 
      #filter for sizes on day 126
    select("Temperature", "pH", "Diameter","TankID")


Growth <- 
  #create column that is growth
  bind_cols(Initial, Final) %>% 
    #binds initial (Diameter) and final (Diameter1) sizes to calculate growth
  mutate(Growth = ((Diameter1 - Diameter)/Diameter*100)) %>% 
    #add column for growth calculation
  select("Growth")


resultsGrow <-
  #table of initial and final size data
  results %>% 
    select("Day", "Treatment", "Temperature", "pH", "TankID", "Diam1", "Diam2") %>% 
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
    filter(Day == "126")
resultsGrow <- bind_cols(resultsGrow, Growth)
  #combines table of initial and final with growth information
```

```{r, results=TRUE}
#LMM for growth:
modGrow <-
  resultsGrow %>% 
  lmer(Growth~ Temperature * pH + (1|TankID), data=.)

#Need to decide on model type that we want to use. 

summary(modGrow)

anova(modGrow, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type II Analysis of Variance Table with Satterthwaite's method.
```

Check assumptions of normality of residuals and homogeneity of variance. Assumptions are met.  
```{r, results=TRUE}
## ASSSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modGrow)) 
shapiro.test(residuals(modGrow)) #passes
hist(residuals(modGrow)) #looks normal


# 2. Equal variances
leveneTest(residuals(modGrow)~resultsGrow$Treatment) #Passes
plot(fitted(modGrow),resid(modGrow,type="pearson"),col="blue")
```

Display exploratory interaction plot.  
```{r, results=TRUE}
#Interaction plot shows slight interaction
interaction.plot(resultsGrow$Temperature,resultsGrow$pH,resultsGrow$Growth,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(Growth)),)
```

### Initial as day -13

Model growth using the start  as the day conditions began to ramp up.  
```{r, results=FALSE}

### GROWTH MODEL 2: If run the same model using day -13 as the first technical day of the experiment. This is the day conditions began to ramp up, so urchins were experiencing gradual increase of stressors.


Initial1 <-
    #seperate out the initial sizes of urchins on day -14, when conditions began to ramp up.
  results %>% 
    select("Day", "Treatment", "Temperature", "pH", "Diam1", "Diam2", "TankID") %>%
    filter(TankID != "8t" ) %>% 
        #remove urchin number 8 which died halfway through
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>%
      #gather Diam1 and Diam2 into single column
    filter(Day == "-13") %>%  
      #filter for day at -13 to use this as the intial size.
    select("Temperature", "pH", "Diameter", "TankID") %>% 
  mean(Initial1$Diameter)
  std.error(Initial1$Diameter)


Final1 <- 
      #seperate out the final sizes of urchins on day 126
   results %>% 
    select("Day", "Treatment", "Temperature", "pH", "Diam1", "Diam2", "TankID") %>% 
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>%
      #gather Diam1 and Diam2 into single column
    filter(Day == "126") %>% 
      #filter for size on last day of experiment
    select("Temperature", "pH", "Diameter","TankID")


Growth1 <- 
  #create column that is growth
  bind_cols(Initial1, Final1) %>% 
    #binds initial (Diameter) and final (Diameter1) sizes to calculate growth
  mutate(Growth = ((Diameter1 - Diameter)/Diameter*100)) %>%
    #add column for growth calculation
  select("Growth")


resultsGrow1 <-
  #table of initial and final size data
  results %>% 
    select("Day", "Treatment", "Temperature", "pH", "TankID", "Diam1", "Diam2") %>% 
    drop_na(Diam1, Diam2) %>% 
    gather(key = "1or2", value = "Diameter", "Diam1", "Diam2") %>% 
    filter(Day == "126")
resultsGrow1 <- bind_cols(resultsGrow1, Growth1)
  #combines table of initial and final with growth information
```

Analyze with linear mixed model.  
```{r, results=TRUE}
#LMM for growth:
modGrow1 <- 
  resultsGrow1 %>% 
  lmer(Growth~ Temperature * pH + (1|TankID), data=.)


summary(modGrow1)

anova(modGrow1, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type III Analysis of Variance Table with Satterthwaite's method.
```

Check assumptions.  
```{r, results=TRUE}
## ASSSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modGrow1)) 
shapiro.test(residuals(modGrow1)) #passes 
hist(residuals(modGrow1)) #looks normal

# 2. Equal variances
leveneTest(residuals(modGrow1)~resultsGrow1$Treatment) #doesn't pass...
plot(fitted(modGrow1),resid(modGrow1,type="pearson"),col="blue")
```

Display exploratory interaction plot.  

```{r, results=TRUE}

#Interaction plot shows interaction
interaction.plot(resultsGrow1$Temperature,resultsGrow1$pH,resultsGrow1$Growth,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(Growth)),)

```


## Calcification

Results:   

There was no significant effect of temperature (p=0.387), pH (p=0.437), or the interaction of both (p=0.091) on the calcification ratio of cross-sections at the tips of T. gratilla spines. At the base of the spines, pH contributed to a significant reduction of the calcification ratio (p=0.002) while temperature did not (p=0.164). Calcification ratios were 16% lower in acidified conditions, regardless of temperature. There was no interaction between temperature and pH on the calcification ratio at the base of the spines (p=0.536). 

### Tips of spines    

Analysis of calcification at the tip of the spine:  

Assemble data.  
```{r Calcification tip, results=FALSE}
### Model 1: calcification at the tips of spines

resultsTip <- 
  #create data using only the SEM images of the tips of spines.
  results %>% 
  select ("Treatment", "Temperature", "pH", "PartOfSpine", "Chosen", "RatioSEM", "TankID") %>% 
    #selects for desired variables. PartOfSpine is tip or base, Chosen indicates which side of the image (arbitrary) is selected for (aka has no dust)
  drop_na(RatioSEM) %>% 
  filter(Chosen == "yes", PartOfSpine == "Tip")
    #filters only for tips and chosen side. No dusty images to be analyzed.
```

Analyse with linear mixed model:  
```{r, results=TRUE}
#LMM for calcification at the tips of spines 
modTip <-
  resultsTip %>% 
  lmer(RatioSEM ~ Temperature * pH + (1|TankID), data = .)

summary(modTip)
Anova(modTip, type=2) #Anova{car}. Produces Analysis of Deviance Table (Type II Wald chisquare tests). Calculates type-II analysis-of-variance tables for model objects produced by lmer in the lme4 package. As implemented here, type-II Wald tests are a generalization of the linear hypotheses used to generate these tests in linear models.
anova(modTip, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type II Analysis of Variance Table with Satterthwaite's method.
```

Check assumptions.  
```{r, results=TRUE}
## ASSSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modTip)) #Normal
shapiro.test(residuals(modTip)) #Pass
hist(residuals(modTip))

# 2. Equal variances
leveneTest(residuals(modTip)~resultsTip$Treatment) #Pass
plot(fitted(modTip),resid(modTip,type="pearson"),col="blue") 
```

Conduct post hoc analysis.  
```{r, results=TRUE}
## POST HOC ANALYSIS 
emmTip <- emmeans(modTip, ~Temperature*pH, adjust = "tukey")  #Estimated marginal means (Least-squares means)
multcomp::cld(emmTip) #create a compact letter display of all pair-wise comparisons
pwpp(emmTip) #Constructs a plot of P values associated with pairwise comparisons of estimated marginal means.
```  

Display interaction plot for exploration.  
```{r, results=TRUE}
#Interaction plot for cacification at the tip of the spines - interaction
interaction.plot(resultsTip$Temperature,resultsTip$pH,resultsTip$RatioSEM,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(Growth)),)
```

### Base of spines  

Assemble data.  
```{r Calcification base}

### Model 2: calcification in the base of the spines

resultsBase <-
   #create data using only the SEM images of the base of spines.
  results %>% 
  select ("Treatment", "Temperature", "pH", "PartOfSpine", "Chosen", "RatioSEM", "TankID") %>% 
    #selects for desired variables. PartOfSpine is tip or base, Chosen indicates which side of the image (arbitrary) is selected for (aka has no dust)
  drop_na(RatioSEM) %>% 
  filter(Chosen == "yes", PartOfSpine == "Base")
    #filters only for tips and chosen side. No dusty images to be analyzed.
```

```{r, results=TRUE}
#LMM for calcification at the tips of spines 
modBase <- 
  resultsBase %>% 
  lmer(RatioSEM~ Temperature * pH + (1|TankID), data=.)

summary(modBase) 
Anova(modBase, type=2) #Anova{car}. Produces Analysis of Deviance Table (Type II Wald chisquare tests). Calculates type-II or type-III analysis-of-variance tables for model objects produced by lmer in the lme4 package. As implemented here, type-II Wald tests are a generalization of the linear hypotheses used to generate these tests in linear models.
anova(modBase, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type III Analysis of Variance Table with Satterthwaite's method.
```

Check assumptions. 

```{r, results=TRUE}
## ASSSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modBase)) #Normal
shapiro.test(residuals(modBase)) # Pass
hist(residuals(modBase))

# 2. Equal variances
leveneTest(residuals(modBase)~resultsBase$Treatment) #Pass
plot(fitted(modBase),resid(modBase,type="pearson"),col="blue")
```

```{r, results=TRUE}
## POST HOC ANALYSIS 
emmBase <- emmeans(modBase, ~Temperature*pH, adjust = "tukey")
  #Estimated marginal means (Least-squares means)
multcomp::cld(emmBase)
  #create a compact letter display of all pair-wise comparisons
pwpp(emmBase)
  #Constructs a plot of P values associated with pairwise comparisons of estimated marginal means.
```

Display interaction plot.  
```{r, results=TRUE}
#Interaction plot for calcification at the base of the spines - no interaction
interaction.plot(resultsBase$Temperature,resultsBase$pH,resultsBase$RatioSEM,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(RatioSEM)),)

```

## Relative Spine Lengths  

Results: 

Although marginally nonsignificant, pH influenced relative spine length (% of TD) (p=0.0509) more than temperature (p=0.196). There was no interaction between temperature and pH (p=0.9326) on relative spine length. 

Analysis: 

Assemble data.  
```{r, Spine Lengths}

### Comparison of spine lengths relative to test diameter

resultsLength <-
  #create data table of only necessary variables
  results %>% 
  select ("Treatment", "Temperature", "pH", "RatioLength", "Chosen", "TankID") %>% 
  drop_na(RatioLength) %>% 
  filter(Chosen == "yes")
``` 

Analyze with linear mixed effect model.  
```{r, results=TRUE}
## LMM for relative spine lengths
modLength <- 
  resultsLength %>% 
  lmer(RatioLength~Temperature*pH + (1|TankID), data=.)

summary(modLength)
Anova(modLength, type=2) #Anova{car}. Produces Analysis of Deviance Table (Type II Wald chisquare tests). Calculates type-II or type-III analysis-of-variance tables for model objects produced by lmer in the lme4 package. As implemented here, type-II Wald tests are a generalization of the linear hypotheses used to generate these tests in linear models.
anova(modLength, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type III Analysis of Variance Table with Satterthwaite's method.
```

Check assumptions.  
```{r, results=TRUE}
### ASSSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modLength)) #Normal
shapiro.test(residuals(modLength)) #Pass
hist(residuals(modLength))

# 2. Equal variances
leveneTest(residuals(modLength)~resultsLength$Treatment) #Pass
plot(fitted(modLength),resid(modLength,type="pearson"),col="blue")
```

Conduct post hoc analysis.  

```{r, results=TRUE}
### POST HOC ANALYSIS 
emmLength <- emmeans(modLength, ~Temperature*pH, adjust = "tukey")
  #Estimated marginal means (Least-squares means)
multcomp::cld(emmLength)
  #create a compact letter display of all pair-wise comparisons
pwpp(emmLength)
  #Constructs a plot of P values associated with pairwise comparisons of estimated marginal means.
```

Display interaction plot.  

```{r, results=TRUE}
#Interaction plot for relative spine lengths - no interaction
interaction.plot(resultsLength$Temperature,resultsLength$pH,resultsLength$RatioLength,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(RatioLength)),)

```

## Dropped Spines

Results:  

Low pH significantly increased the number of spines shed on the bottom of the tank regardless of temperature throughout the experimental period (p<0.0001). Urchins in low pH and ambient temperatures shed more spines than those in the control (ambient pH and ambient temperature) (p = 0.004) and ambient pH and high temperatures (p = 0.045). Those in low pH and high temperatures also shed more spines than those in the control (p=0.011). 

Analysis:  

Assemble data.  
```{r Dropped Spines}

## Number of loose spines counted at the bottom of tanks at the end of the experiment. These were either broken or shed. Note: these spines were not collected, just counted, so can not determine whether they were broken or shed.

resultsDropped <-
  #create data using only the needed variables.
  results %>% 
  select ("Treatment", "Temperature", "pH", "SpineCount", "TankID") %>% 
  drop_na(SpineCount)
```

Analyse with linear mixed effect model.  

```{r, results=TRUE}
##LM of dropped spines - can't make it LMM because error: number of levels of each grouping factor must be < number of observations - only have one count for each TankID.
modDropped <- 
  resultsDropped %>% 
  lm(SpineCount~ Temperature * pH, data=.)

summary(modDropped)
Anova(modDropped, type=2) #Anova{car}. Produces Analysis of Deviance Table (Type II Wald chisquare tests). Calculates type-II or type-III analysis-of-variance tables for model objects produced by lmer in the lme4 package. As implemented here, type-II Wald tests are a generalization of the linear hypotheses used to generate these tests in linear models.
anova(modDropped, type="II") #anova{stats}.Compute analysis of variance (or deviance) tables for one or more fitted model objects. Produces Type III Analysis of Variance Table with Satterthwaite's method.
```

```{r, results=TRUE}
##ASSUMPTIONS
# 1. Normality of residuals
qqPlot(residuals(modDropped)) #not normal
shapiro.test(residuals(modDropped)) #faaaiiilll
hist(residuals(modDropped))

# 2. Equal variances
leveneTest(residuals(modDropped)~resultsDropped$Treatment) # barely pass
plot(fitted(modDropped),resid(modDropped,type="pearson"),col="blue")
```

Analysis does not meet assumptions. Attempt a square root transformation.  

```{r, results=TRUE}
##DOES NOT MEET ASSUMPTIONS so ATTEMPT AT Transformation:
resultsDropped$tdata<-(resultsDropped$SpineCount)^1/2
  # transformation
modDropped1 <- lm(tdata~ Temperature * pH, data=resultsDropped)
  # run lm model of transformed data

###ASSUMPTIONS for Transformation
# 1. Normality of residuals
qqPlot(residuals(modDropped1)) #not normal
shapiro.test(residuals(modDropped1)) #fail
hist(residuals(modDropped1))
# 2. equal variances
bartlett.test(residuals(modDropped1)~resultsDropped$Treatment) #fail
plot(fitted(modDropped1),resid(modDropped1,type="pearson"),col="blue")


summary(modDropped1)
Anova(modDropped1, type=2) #test for significance of model
```

Transfomraiton was not successful, so we use a non parametric Kruskal Wallis Test.  
```{r, results=TRUE}
### Transformations not work, so use non parametric:
kruskal.test(resultsDropped$SpineCount~resultsDropped$Treatment)# SIG*** (p=0.0005563)
```

Conduct Dunn Post Hoc Test and display interaction plot. 
```{r, results=TRUE}
### POST HOC Pairwise ######
dunn <- 
  resultsDropped %>% 
  dunnTest(SpineCount ~ Treatment,
           method = "holm", kw = TRUE, data = .)
dunnph <- dunn$res
cldList(P.adj ~ Comparison, data = dunnph, threshold = 0.05)

#Interaction plot for dropped spines - no interaction
interaction.plot(resultsDropped$Temperature,resultsDropped$pH,resultsDropped$SpineCount,
                 type = c("l","p", "b", "o","c"), legend = TRUE,
                 trace.label = deparse(substitute(pH)),
                 fixed = FALSE,
                 xlab = deparse(substitute(Temperature)),
                 ylab = deparse(substitute(SpineCount)),)

```

