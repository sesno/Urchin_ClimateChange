---
title: "Plots for growth and calcification responce of the common collector urchin, _Tripneustes gratilla_, to projected climate change: effects of warming and acidification."
author: "Emily Sesno"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
    smart: false
  pdf_document:
    keep_tex: yes
---

```{r setup, message=FALSE, warning=FALSE}
rm(list=ls(all=TRUE))
results <- read.csv("Data/Urchin_ClimateChange_Data.csv", header=T, na.strings="NA")

library("tidyverse")
library("lme4") #linear mixed modeling
library("lmtest") #linear mixed modeling
library("lmerTest") #calculate p-values in models
library("car") #levenes tests
library("emmeans") #post-hoc tests
library("lsmeans") #post-hoc tests
library("plotrix") #calculate std.error
library("dplyr") 
library("cowplot") #grid plotting 
```

## Methods

### Statistical Analyses (see analysis script)  

Residuals were checked for normality and confirmed with the Shapiro-Wilk test and homogeniety of variance was confirmed using Levene’s test. Temperature and pH treatment condition data were not normal, so were analyzed using a Kruskal-Wallis test. Effect of temperature and pH treatments on growth (%), calcification ratio, and relative spine length (% of TD) were analyzed using linear mixed effects models in the lme4 package (Bates, et al. 2015) in R Statistical Programming (R Core Team, 2018). Temperature and pH were included as fixed factors with individual urchin included as a random effect. Significance of effects was determined using a type II analysis of variance (ANOVA) producing a deviance table with Wald chi-square tests in the car package (Fox et al. 2019). Alpha was set to 0.05 for all analyses. Analysis of dropped spines was conducted using a Kruskal-Wallis test (Alexis Dinno, 2017) as the normality assumption was violated. Data visualization and analysis was conducted using the programs JMP® Pro 13.1.0 (SAS Institute Inc., 2019) and R Version 1.2.1335 (R Core Team, 2018).

## Results  

### Treatment Conditions
	
The achieved conditions of header tanks were not different between the same temperature and pH treatments, so were pooled with analysis of environmental conditions in the tanks. Temperatures were not significantly different among all ambient tanks (Chi square = 1.96; p = 0.9995, df = 12) and among all high temperature tanks (Chi square = 8.69; p = 0.7293, df = 12), but were different between ambient and high temperature tanks (Chi square = 148.13; p <0.0001, df = 24). Similarly, pH levels were not significantly different among all ambient tanks (Chi square = 19.60; p = 0.0750, df = 12) and all low pH tanks (Chi square = 13.54; p = 0.3310, df = 12), but were different between ambient and low pH tanks (Chi square = 323.46; p <0.0001, df = 24). 


```{r, results=TRUE}

tempsummary<-results %>% 
  select("Day", "Temperature", "Temp") %>%
  drop_na(Temp) %>%
  group_by(Day, Temperature) %>%
  mutate(meanT = mean(Temp)) %>%
  group_by(Temperature) %>% 
  mutate(sd = sd(Temp)) %>%
  mutate(se = sd/sqrt(12)) 
  
  
tempplot<-ggplot(data=tempsummary, aes(Day, meanT, color = Temperature)) +
    geom_point(size = 2.5, show.legend=FALSE) +
    geom_errorbar(aes(ymin = meanT-se, ymax = meanT+se)) +
    geom_line(size=1.2) +
    scale_x_continuous(name="Time (Day)", breaks = seq(0,130, by = 10)) +
    scale_y_continuous(name="Temperature (°C)", breaks = seq(20,30, by = 1)) +
    scale_shape_discrete(name = NULL,
                         labels = c("Ambient", "High"))+
    scale_color_manual(name = NULL,
                       values = c("gray40", "firebrick3"),
                       labels = c("Ambient", "High")) +
    ggtitle("")+
    theme_classic() +
    theme(plot.margin=unit(c(0.3,0.6,0.3,0.3), "cm"))+
    theme(legend.margin = margin(0), 
          legend.position = c(.98,.8), 
          legend.justification = c("right", "top"),
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14, face="bold"));tempplot
```

```{r, results=TRUE}

pHsummary<-results %>% 
  select("Day","pH", "pHspec") %>%
  drop_na(pHspec) %>%
  group_by(Day, pH) %>%
  mutate(meanpH = mean(pHspec)) %>%
  group_by(pH, meanpH) %>% 
  mutate(sd = sd(pHspec)) %>%
  mutate(se = sd/sqrt(12)) 
  
  
pHplot<-ggplot(data=pHsummary, aes(Day, meanpH, color = pH)) +
    geom_point(size = 2.5, show.legend=FALSE) +
    geom_errorbar(aes(ymin = meanpH-sd, ymax = meanpH+sd)) +
    geom_line(size=1.2) +
    scale_x_continuous(name="Time (Day)", breaks = seq(0,130, by = 10)) +
    scale_y_continuous(name="pH (Total Scale)", breaks = seq(7.5,8.1, by = .1)) +
    scale_shape_discrete(name = NULL,
                         labels = c("Low pH", "High pH"))+
    scale_color_manual(name = NULL,
                       values = c("skyblue3", "gray40"),
                       labels = c("Acidified", "Ambient"),
                       guide = guide_legend(reverse = TRUE)) +
    ggtitle("")+
    theme_classic() +
    theme(plot.margin=unit(c(0.3,0.6,0.3,0.3), "cm"))+
    theme(legend.margin = margin(0), 
          legend.position = c(.98,.8), 
          legend.justification = c("right", "top"),
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14, face="bold"));pHplot
```


```{r, results=TRUE}

#Make plots in horizontal line with proper labeling of a and b

treatmentfig1<-plot_grid(tempplot, pHplot, labels = c("a", "b"), ncol=2, nrow=1, rel_heights= c(1,1), rel_widths = c(1,1), label_size = 20, label_y=1, align="h");treatmentfig1

ggsave(filename="Figures/20200611/TreatmentFig1.png", plot=treatmentfig1, dpi=300, width=16, height=6, units="in")

```

**Figure 3.1.** Temperature (a) and pH (b) conditions over the 126-day experiment period. Data are mean ± standard error (s.e.). Where error bars are not visible, error is too small to be seen. Days prior to 0 indicate the acclimation and conditioning period.


### Growth: 

Test diameters were not significantly different among all urchins upon initial collection (mean = 7.54  0.29 mm; n=24; F3,20=0.851; p=0.4825) or after subsequent ramp-up of conditions (mean = 16.12  0.67 mm; n=24; F3,20=1.0907; p=0.3759). Increased temperatures significantly influenced growth (p = 0.042) while pH did not (p=0.611) (Fig. 3.2). Urchins grown in increased temperatures were 12 % larger than those in ambient conditions, regardless of pH. There was no interaction between temperature and pH (p=0.482) (Fig. 3.2).


```{r, echo = FALSE}
#### Growth Interaction Plot
##May need to adjust the p value for temp depending on which Anova() or anova() we use...

growthsummary<-results %>% 
  filter(Day==126) %>%
  select("pH", "Temperature","Growth") %>%
  drop_na(Growth) %>% 
  mutate(meanPct = Growth*100) %>%
  group_by(pH, Temperature) %>%
  summarise(mean = mean(meanPct), 
            N = length(meanPct),
            se = std.error(meanPct))
   
  
growthplot<-ggplot(data=growthsummary, aes(x=Temperature, y=mean, color = pH, group=interaction(Temperature,pH))) +
    geom_point(size = 3,  position=position_dodge(0.1)) +
    geom_line(aes(group=pH),  position=position_dodge(0.1)) +
    xlab("Temperature Treatment") +
    ylab("Total Growth (%)")+
    geom_errorbar(aes(ymin = mean-se, ymax = mean+se, width = 0.1), position=position_dodge(0.1)) +
    theme_bw() + 
    scale_x_discrete(limits=c("ambient", "heated"), 
                     label=c("Ambient", "High"))+
    scale_colour_manual(name = "pH Treatment",
                        values = c("skyblue3", "gray40"),
                        labels = c("Acidified", "Ambient"),
                        guide = guide_legend(reverse = TRUE)) +
    geom_text(x=1.5, y=125, label="p(pH)=0.61", size=6, color="darkgray") + 
    geom_text(x=1.5, y=100, label="p(Temperature)=0.04", size=6, color="black") + 
    geom_text(x=1.5, y=75, label="p(Interaction)=0.47", size=6, color="darkgray") + 
    ylim(0,450)+
    theme_classic()+
    theme(legend.position = "right", 
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14), 
          legend.title = element_text(size=16, face="bold"));growthplot

ggsave(filename="Figures/20200611/GrowthFig.png", plot=growthplot, dpi=300, width=8, height=6, units="in")

```

**Figure 3.2.** Effect of (a) temperature and (b) pH on growth (%) of Tripneustes gratilla test diameters after 126-day exposure period. Data are mean ± standard error (s.e.), n= 11-12.


### Calcification Ratio  

There was no significant effect of temperature (p=0.387), pH (p=0.437), or the interaction of both (p=0.091) on the calcification ratio of cross-sections at the tips of T. gratilla spines. At the base of the spines, pH contributed to a significant reduction of the calcification ratio (p=0.002) while temperature did not (p=0.164). Calcification ratios were 16% lower in acidified conditions, regardless of temperature. There was no interaction between temperature and pH on the calcification ratio at the base of the spines (p=0.536) (Fig. 3.3). 


```{r, echo = FALSE}
#### Tip and base calcification ratios

#base
basesummary<-results %>% 
  select("Temperature","pH","RatioSEM", "PartOfSpine") %>%
  filter(PartOfSpine=="Base")%>%
  drop_na(RatioSEM) %>% 
  group_by(pH, Temperature, PartOfSpine) %>%
  summarize(mean = mean(RatioSEM), se = std.error(RatioSEM), N = length(RatioSEM))
  
baseplot<- ggplot(data=basesummary, aes(x=Temperature, y=mean, color = pH, group=interaction(Temperature,pH))) +
    geom_point(size = 3,  position=position_dodge(0.1)) +
    geom_line(aes(group=pH),  position=position_dodge(0.1)) +
    xlab("Temperature Treatment") +
    ylab("Spine Base Calcification Ratio")+
    ylim(1,3.5)+
    geom_errorbar(aes(ymin = mean-se, ymax = mean+se, width = 0.1), position=position_dodge(0.1)) +
    theme_bw() + 
    scale_x_discrete(limits=c("ambient", "heated"), 
                     label=c("Ambient", "High"))+
    scale_colour_manual(name = "pH Treatment",
                        values = c("skyblue3", "gray40"),
                        labels = c("Acidified", "Ambient"),
                        guide = guide_legend(reverse = TRUE)) +
    geom_text(x=1.5, y=1.6, label="p(pH)=0.002", size=6, color="black") + 
    geom_text(x=1.5, y=1.4, label="p(Temperature)=0.16", size=6, color="darkgray") + 
    geom_text(x=1.5, y=1.2, label="p(Interaction)=0.54", size=6, color="darkgray") + 
    theme_classic()+
    theme(legend.position = "right", 
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14), 
          legend.title = element_text(size=16, face="bold"));baseplot

ggsave(filename="Figures/20200611/BaseCalcificationFig.png", plot=baseplot, dpi=300, width=8, height=6, units="in")

#tip
tipsummary<-results %>% 
  select("Temperature","pH","RatioSEM", "PartOfSpine") %>%
  filter(PartOfSpine=="Tip")%>%
  drop_na(RatioSEM) %>% 
  group_by(pH, Temperature, PartOfSpine) %>%
  summarize(mean = mean(RatioSEM), se = std.error(RatioSEM), N = length(RatioSEM))

tipplot<-ggplot(data=tipsummary, aes(x=Temperature, y=mean, color = pH, group=interaction(Temperature,pH))) +
    geom_point(size = 3,  position=position_dodge(0.1)) +
    geom_line(aes(group=pH),  position=position_dodge(0.1)) +
    xlab("Temperature Treatment") +
    ylab("Spine Tip Calcification Ratio")+
    ylim(1,3.5)+
    geom_errorbar(aes(ymin = mean-se, ymax = mean+se, width = 0.1), position=position_dodge(0.1)) +
    theme_bw() + 
    scale_x_discrete(limits=c("ambient", "heated"), 
                     label=c("Ambient", "High"))+
    scale_colour_manual(name = "pH Treatment",
                        values = c("skyblue3", "gray40"),
                        labels = c("Acidified", "Ambient"),
                        guide = guide_legend(reverse = TRUE)) +
    geom_text(x=1.5, y=3.0, label="p(pH)=0.44", size=6, color="darkgray") + 
    geom_text(x=1.5, y=2.8, label="p(Temperature)=0.39", size=6, color="darkgray") + 
    geom_text(x=1.5, y=2.6, label="p(Interaction)=0.09", size=6, color="darkgray") + 
    theme_classic()+
    theme(legend.position = "none", #removed the legend for the tip, so when we align them horizontally we only have one legend. But need to adjust the size so it is the same as base
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14), 
          legend.title = element_text(size=16, face="bold"));tipplot

ggsave(filename="Figures/20200611/TipCalcificationFig.png", plot=tipplot, dpi=300, width=8, height=6, units="in")
```

```{r, results=TRUE}

#Make plots of calcification at tip and base in horizontal line with proper labeling of a and b
#removed legend on the tip, so they can share the same one. But now they are different sizes...

calcificationfig1<-plot_grid(tipplot, baseplot, labels = c("a", "b"), ncol=2, nrow=1, rel_heights= c(1,1), rel_widths = c(1,1), label_size = 20, label_y=1, align="h");calcificationfig1

ggsave(filename="Figures/20200611/CalcificationFig1.png", plot=calcificationfig1, dpi=300, width=16, height=6, units="in")

```


**Figure 3.3.** Effect of temperature and pH on the calcification ratio at the tip (a) and base (b) of spine cross-sections. Data are means ± standard error (s.e.), n = 14-18.


### Spine Length  

Although marginally nonsignificant, pH influenced relative spine length (% of TD) (p=0.0509) more than temperature (p=0.196). There was no interaction between temperature and pH (p=0.9326) on relative spine length (Fig. 3.4). 

```{r, echo = FALSE}

length_summary<-results %>% 
  select("Temperature","pH","RatioLength", "Chosen") %>%
  drop_na(RatioLength) %>%
  mutate(Ratio = RatioLength/2) %>% 
  filter(Chosen == "yes") %>% 
  group_by(pH, Temperature) %>%
  summarize(mean = mean(Ratio), se = std.error(Ratio), N = length(Ratio))

  lengthplot<-ggplot(data=length_summary, aes(x=Temperature, y=mean, color = pH, group=interaction(Temperature,pH))) +
    geom_point(size = 3,  position=position_dodge(0.1)) +
    geom_line(aes(group=pH),  position=position_dodge(0.1)) +
    xlab("Temperature Treatment") +
    ylab("Spine Length : Diameter")+
    geom_errorbar(aes(ymin = mean-se, ymax = mean+se, width = 0.1), position=position_dodge(0.1)) +
    ylim(10,20) +
    theme_bw() + 
    geom_text(x=1.5, y=12.5, label="p(pH)=0.05", size=6, color="darkgray") + 
    geom_text(x=1.5, y=12, label="p(Temperature)=0.20", size=6, color="darkgray") + 
    geom_text(x=1.5, y=11.5, label="p(Interaction)=0.93", size=6, color="darkgray") + 
    scale_x_discrete(limits=c("ambient", "heated"), 
                     label=c("Ambient", "High"))+
    scale_colour_manual(name = "pH Treatment",
                        values = c("skyblue3", "gray40"),
                        labels = c("Acidified", "Ambient"),
                        guide = guide_legend(reverse = TRUE)) +
    #ylim(250,450)+
    theme_classic()+
    theme(legend.position = "right", 
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14), 
          legend.title = element_text(size=16, face="bold"));lengthplot

ggsave(filename="Figures/20200611/LengthFig.png", plot=lengthplot, dpi=300, width=8, height=6, units="in")
```

**Figure 3.4.** Effect of temperature and pH on the relative spine lengths (Ratio of spine length: diameter). Data are means ± standard error (s.e.), n = 51.

### Dropped Spines  

Low pH significantly increased the number of spines shed on the bottom of the tank regardless of temperature throughout the experimental period (p<0.0001). Urchins in low pH and ambient temperatures shed more spines than those in the control (ambient pH and ambient temperature) (p = 0.004) and ambient pH and high temperatures (p = 0.045). Those in low pH and high temperatures also shed more spines than those in the control (p=0.011) (Fig 3.5). 


```{r, echo = FALSE}

droppedsummary<-results %>% 
  select("Temperature","pH","SpineCount") %>%
  drop_na(SpineCount) %>% 
  group_by(pH, Temperature) %>%
  summarize(mean = mean(SpineCount), se = std.error(SpineCount), N = length(SpineCount))

  dropplot<-ggplot(data=droppedsummary, aes(x=Temperature, y=mean, color = pH, group=interaction(Temperature,pH))) +
    geom_point(size = 3,  position=position_dodge(0.1)) +
    geom_line(aes(group=pH),  position=position_dodge(0.1)) +
    xlab("Temperature Treatment") +
    ylab("Dropped Spines")+
    geom_errorbar(aes(ymin = mean-se, ymax = mean+se, width = 0.1), position=position_dodge(0.1)) +
    ylim(0,30) +
    theme_bw() + 
    scale_x_discrete(limits=c("ambient", "heated"), 
                     label=c("Ambient", "High"))+
    scale_colour_manual(name = "pH Treatment",
                        values = c("skyblue3", "gray40"),
                        labels = c("Acidified", "Ambient"),
                        guide = guide_legend(reverse = TRUE)) +
    geom_text(x=1.5, y=11, label="p(pH)<0.001", size=6, color="black") + 
    geom_text(x=1.5, y=9, label="p(Temperature)=0.91", size=6, color="darkgray") + 
    geom_text(x=1.5, y=7, label="p(Interaction)=0.83", size=6, color="darkgray") +
    theme_classic()+
    theme(legend.position = "right", 
          legend.background = element_blank(), 
          axis.title = element_text(size = 16, face="bold"),
          axis.text = element_text(size = 14), 
          plot.title = element_text(size=16, face="bold"),
          legend.text = element_text(size=14), 
          legend.title = element_text(size=16, face="bold"));dropplot

ggsave(filename="Figures/20200611/DroppedSpinesFig.png", plot=dropplot, dpi=300, width=8, height=6, units="in")
```

**Figure 3.5.** Effect of temperature and pH on the number of spines dropped. Data are means + standard error (s.e.), n = 5-6  
